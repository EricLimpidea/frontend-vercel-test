<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Test Vercel + Render (réaliste)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, Arial; padding: 24px; }
    .card { padding: 16px; border: 1px solid #ddd; border-radius: 12px; margin: 12px 0; }
    button { padding: 10px 12px; border-radius: 10px; border: 1px solid #ddd; background: #fff; cursor: pointer; }
    pre { white-space: pre-wrap; word-break: break-word; }
  </style>
</head>
<body>
  <h1>Frontend (Vercel) → Backend (Render)</h1>

  <div class="card">
    <strong>1) Health check</strong>
    <pre id="health">Chargement...</pre>
  </div>

  <div class="card">
    <strong>2) Hello JSON</strong>
    <pre id="hello">Chargement...</pre>
  </div>

  <div class="card">
    <strong>3) Streaming SSE (type IA)</strong><br/><br/>
    <button id="start">Démarrer streaming</button>
    <button id="stop">Stop</button>
    <pre id="stream">(vide)</pre>
  </div>

  <script>
    // Variable pour stocker l'URL de l'API depuis la variable d'environnement Vercel
    let API_BASE = null;
  
    // Charge la configuration depuis l'API Vercel
    async function loadConfig() {
      try {
        const res = await fetch('/api/config');
        const data = await res.json();
        if (data.apiBase) {
          API_BASE = data.apiBase;
          // Affiche l'URL dans la page pour être sûr que Vercel a bien la bonne version
          document.body.insertAdjacentHTML(
            "beforeend",
            `<p><strong>API_BASE:</strong> <code>${API_BASE}</code></p>`
          );
          // Charge les données une fois la config disponible
          loadJson("/api/health", "health");
          loadJson("/api/hello", "hello");
        } else {
          document.body.insertAdjacentHTML(
            "beforeend",
            `<p style="color: red;"><strong>Erreur:</strong> Variable d'environnement API_BASE_URL non définie</p>`
          );
        }
      } catch (e) {
        console.error("Erreur lors du chargement de la config", e);
        document.body.insertAdjacentHTML(
          "beforeend",
          `<p style="color: red;"><strong>Erreur:</strong> Impossible de charger la configuration: ${e.message}</p>`
        );
      }
    }
  
    async function loadJson(path, elId) {
      if (!API_BASE) {
        document.getElementById(elId).textContent = "En attente de la configuration...";
        return;
      }
      
      const el = document.getElementById(elId);
      const url = API_BASE + path;
  
      try {
        const res = await fetch(url, { cache: "no-store" });
        // Même si HTTP 404/500, fetch réussit → on le verra ici
        const text = await res.text();
  
        if (!res.ok) {
          el.textContent = `HTTP ${res.status} sur ${url}\n\n${text}`;
          return;
        }
  
        // On essaie de parser en JSON
        try {
          const json = JSON.parse(text);
          el.textContent = JSON.stringify(json, null, 2);
        } catch {
          el.textContent = `Réponse non-JSON sur ${url}\n\n${text}`;
        }
      } catch (e) {
        // Ici: DNS/CORS/Network/SSL → typiquement "Load failed"
        console.error("FETCH FAILED", url, e);
        el.textContent = `Fetch failed sur ${url}\n\n${e?.message || e}`;
      }
    }
  
    // Charge la configuration au démarrage
    loadConfig();
  
    // SSE
    let es = null;
  
    document.getElementById("start").addEventListener("click", () => {
      if (!API_BASE) {
        alert("Configuration non chargée. Veuillez attendre...");
        return;
      }
      
      const out = document.getElementById("stream");
      out.textContent = "";
  
      if (es) es.close();
      const url = API_BASE + "/api/stream";
      out.textContent = `[connecting] ${url}\n`;
  
      es = new EventSource(url);
  
      es.addEventListener("token", (evt) => {
        const data = JSON.parse(evt.data);
        out.textContent += data.token;
      });
  
      es.addEventListener("done", () => {
        out.textContent += "\n\n[done]";
        es.close();
        es = null;
      });
  
      es.onerror = (err) => {
        console.error("SSE ERROR", url, err);
        out.textContent += "\n\n[sse error]";
        if (es) es.close();
        es = null;
      };
    });
  
    document.getElementById("stop").addEventListener("click", () => {
      if (es) es.close();
      es = null;
      document.getElementById("stream").textContent += "\n\n[stopped]";
    });
  </script>
  </body>
</html>
